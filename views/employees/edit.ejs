<% layout('layouts/boilerplate') %>

<h1>Edit Employee</h1>

<form action="/employees/<%= employee.id %>?_method=PUT" method="POST" class="form">
    <div class="form-group">
        <label for="name">Name</label>
        <input type="text" name="name" id="name" value="<%= employee.name %>" required>
    </div>

    <div class="form-group">
        <label for="email">Email</label>
        <input type="email" name="email" id="email" value="<%= employee.email %>" required>
    </div>

    <hr style="margin: 25px 0;">
    <h3>User Account & Access</h3>

    <% if (linkedUser) { %>
    <div class="form-group">
        <label for="role">User Role</label>
        <select name="role" id="role">
            <option value="EMPLOYEE" <%= linkedUser.role === 'EMPLOYEE' ? 'selected' : '' %>>Employee</option>
            <option value="ADMIN" <%= linkedUser.role === 'ADMIN' ? 'selected' : '' %>>Admin</option>
        </select>
        <small style="color: #666;">Change user's system access level</small>
    </div>
    <div style="padding: 10px; background-color: #e8f4f8; border-radius: 5px; font-size: 13px; margin-bottom: 15px;">
        <strong>‚úÖ User Account Active</strong> - This employee can log into the system with role: <strong><%= linkedUser.role === 'ADMIN' ? 'üëë Admin' : 'üë§ Employee' %></strong>
    </div>
    <% } else { %>
    <div style="padding: 15px; background-color: #fff9e6; border-left: 4px solid #ffc107; border-radius: 5px; margin-bottom: 15px;">
        <h4 style="margin-top: 0; color: #856404;">‚ö†Ô∏è No User Account</h4>
        <p style="color: #856404; margin-bottom: 0;">
            This employee doesn't have login credentials yet. Save this form first, then use the "Create User Account" section below.
        </p>
    </div>
    <% } %>

    <div class="form-group">
        <label for="startDate">Start Date</label>
        <input type="date" name="startDate" id="startDate" value="<%= employee.startDate.toISOString().split('T')[0] %>" required>
    </div>

    <div class="form-group">
        <label for="vacationDaysPerYear">Vacation Days Per Year</label>
        <input type="number" name="vacationDaysPerYear" id="vacationDaysPerYear" value="<%= employee.vacationDaysPerYear %>" min="0" required>
    </div>

    <div class="form-group">
        <label for="holidayDaysPerYear">Holiday Days Per Year</label>
        <input type="number" name="holidayDaysPerYear" id="holidayDaysPerYear" value="<%= employee.holidayDaysPerYear %>" min="0" required>
    </div>

    <hr style="margin: 25px 0;">
    <h3>Telegram Bot Settings</h3>

    <div class="form-group">
        <label for="arrivalWindowStart">Arrival Window Start</label>
        <input type="time" name="arrivalWindowStart" id="arrivalWindowStart" value="<%= employee.arrivalWindowStart %>" required>
        <small style="color: #666;">When employee can start arriving</small>
    </div>

    <div class="form-group">
        <label for="arrivalWindowEnd">Arrival Window End</label>
        <input type="time" name="arrivalWindowEnd" id="arrivalWindowEnd" value="<%= employee.arrivalWindowEnd %>" required>
        <small style="color: #666;">Latest time to arrive without being late</small>
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" name="exemptFromTracking" id="exemptFromTracking" <%= employee.exemptFromTracking ? 'checked' : '' %>>
            Exempt from Attendance Tracking
        </label>
        <small style="color: #666; display: block; margin-left: 24px;">
            Skip arrival/departure checks and late notifications (e.g., for executives)
        </small>
    </div>

    <div class="form-group">
        <label for="workHoursPerDay">Work Hours Per Day</label>
        <input type="number" name="workHoursPerDay" id="workHoursPerDay" value="<%= employee.workHoursPerDay %>" min="1" max="12" required>
        <small style="color: #666;">Standard work hours (usually 8)</small>
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" name="halfDayOnFridays" id="halfDayOnFridays" <%= employee.halfDayOnFridays ? 'checked' : '' %>>
            Half Day on Fridays
        </label>
    </div>

    <div class="form-group">
        <label for="workHoursOnFriday">Work Hours on Friday</label>
        <input type="number" name="workHoursOnFriday" id="workHoursOnFriday" value="<%= employee.workHoursOnFriday %>" min="1" max="12" required>
        <small style="color: #666;">If half day, usually 4 hours</small>
    </div>

    <div class="form-group">
        <label>Recurring Home Office Days</label>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
            <% const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; %>
            <% for (let i = 0; i < 7; i++) { %>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" name="recurringHomeOfficeDays" value="<%= i %>"
                           <%= employee.recurringHomeOfficeDays && employee.recurringHomeOfficeDays.includes(i) ? 'checked' : '' %>>
                    <%= dayNames[i] %>
                </label>
            <% } %>
        </div>
        <small style="color: #666;">Days when employee always works from home</small>
    </div>

    <hr style="margin: 25px 0;">
    <h3>ClickUp Integration</h3>

    <% if (clickupEnabled) { %>
        <div style="padding: 10px; background-color: <%= employee.clickupApiToken ? '#e8f4f8' : '#fff9e6' %>; border-radius: 5px; font-size: 13px; margin-bottom: 15px;">
            <% if (employee.clickupApiToken) { %>
                <strong>‚úÖ ClickUp Configured</strong> - Employee has their own API token
            <% } else { %>
                <strong>‚ö†Ô∏è ClickUp Not Configured</strong> - Please add employee's ClickUp API token below
            <% } %>
        </div>

        <div class="form-group">
            <label for="clickupApiToken">ClickUp API Token (Personal)</label>
            <input type="text" name="clickupApiToken" id="clickupApiToken"
                   value="<%= employee.clickupApiToken ? (employee.clickupApiToken.substring(0, 20) + '...') : '' %>"
                   placeholder="pk_123456789_ABCDEFGHIJKLMNOPQRSTUVWXYZ">
            <small style="color: #666;">Employee's personal ClickUp API token from ClickUp Settings ‚Üí Apps ‚Üí API Token</small>
        </div>

        <div class="form-group">
            <label for="clickupUserId">ClickUp User ID</label>
            <input type="text" name="clickupUserId" id="clickupUserId"
                   value="<%= employee.clickupUserId || '' %>"
                   placeholder="Enter ClickUp user ID">
            <small style="color: #666;">Get from ClickUp workspace members or leave empty to auto-match by email</small>
        </div>

        <div class="form-group">
            <label for="clickupWorkspaceId">Workspace ID</label>
            <input type="text" name="clickupWorkspaceId" id="clickupWorkspaceId"
                   value="<%= employee.clickupWorkspaceId || '' %>"
                   placeholder="Select workspace below or enter manually">
            <button type="button" class="btn btn-secondary" onclick="loadWorkspaces()">Load Workspaces</button>
            <div id="workspacesList" style="margin-top: 10px;"></div>
        </div>

        <div class="form-group">
            <label for="clickupSpaceId">Space ID</label>
            <input type="text" name="clickupSpaceId" id="clickupSpaceId"
                   value="<%= employee.clickupSpaceId || '' %>"
                   placeholder="Select space below or enter manually">
            <button type="button" class="btn btn-secondary" onclick="loadSpaces()">Load Spaces</button>
            <div id="spacesList" style="margin-top: 10px;"></div>
        </div>

        <div class="form-group">
            <label for="clickupListId">Task List ID</label>
            <input type="text" name="clickupListId" id="clickupListId"
                   value="<%= employee.clickupListId || '' %>"
                   placeholder="Select list below or enter manually">
            <button type="button" class="btn btn-secondary" onclick="loadLists()">Load Lists</button>
            <div id="listsList" style="margin-top: 10px;"></div>
            <small style="color: #666;">This employee's personal task list in ClickUp</small>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label>Webhook Notifications</label>
            <% if (employee.clickupWebhookId) { %>
                <div style="padding: 10px; background-color: #d4edda; border-radius: 5px; margin-bottom: 10px;">
                    <strong>‚úÖ Webhook Active</strong> - Employee will receive Telegram notifications for task events
                    <br>
                    <small>Webhook ID: <%= employee.clickupWebhookId %></small>
                </div>
                <button type="button" class="btn btn-danger" onclick="unregisterWebhook()">Unregister Webhook</button>
            <% } else { %>
                <div style="padding: 10px; background-color: #fff3cd; border-radius: 5px; margin-bottom: 10px;">
                    <strong>‚ö†Ô∏è Webhook Not Registered</strong> - Employee won't receive automatic notifications
                </div>
                <button type="button" class="btn btn-primary" onclick="registerWebhook()"
                        <%= !employee.clickupListId || !employee.clickupWorkspaceId ? 'disabled' : '' %>>
                    Register Webhook
                </button>
                <% if (!employee.clickupListId || !employee.clickupWorkspaceId) { %>
                    <small style="color: #856404; display: block; margin-top: 5px;">
                        Configure workspace and list first, then save before registering webhook
                    </small>
                <% } %>
            <% } %>
        </div>
    <% } else { %>
        <div style="padding: 15px; background-color: #fff9e6; border-left: 4px solid #ffc107; border-radius: 5px;">
            <strong>‚ö†Ô∏è ClickUp Not Configured</strong>
            <p style="margin: 5px 0 0 0; color: #856404;">
                Enable ClickUp integration in <a href="/config/bot">Bot Settings</a> first.
            </p>
        </div>
    <% } %>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Update Employee</button>
        <a href="/employees/<%= employee.id %>" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<% if (!linkedUser) { %>
<div class="card" style="margin-top: 30px;">
    <div class="card-body">
        <h3>Create User Account</h3>
        <p style="color: #666;">After creating employee details above, use this form to give them system login access.</p>

        <form action="/employees/<%= employee.id %>/create-user" method="POST">
            <div class="form-group">
                <label for="userPassword">Password</label>
                <input type="password" name="password" id="userPassword" required minlength="6"
                       placeholder="Enter password (min 6 characters)">
            </div>

            <div class="form-group">
                <label for="userRole">Role</label>
                <select name="role" id="userRole">
                    <option value="EMPLOYEE">Employee</option>
                    <option value="ADMIN">Admin</option>
                </select>
                <small style="color: #666;">
                    Admin: Full access to all features | Employee: Limited access
                </small>
            </div>

            <button type="submit" class="btn btn-primary">Create User Account</button>
        </form>
    </div>
</div>
<% } %>

<form action="/employees/<%= employee.id %>?_method=DELETE" method="POST" style="margin-top: 20px;">
    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this employee? All associated events will also be deleted.')">Delete Employee</button>
</form>

<script>
    async function loadWorkspaces() {
        const container = document.getElementById('workspacesList');
        container.innerHTML = '<p>Loading...</p>';

        try {
            const response = await fetch('/employees/<%= employee.id %>/clickup/workspaces');
            if (!response.ok) throw new Error('Failed to load workspaces');

            const workspaces = await response.json();
            if (workspaces.length === 0) {
                container.innerHTML = '<p style="color: #666;">No workspaces found</p>';
                return;
            }

            let html = '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">';
            workspaces.forEach(ws => {
                html += `<div style="padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 4px; cursor: pointer;"
                              onclick="selectWorkspace('${ws.id}', '${ws.name}')">
                            <strong>${ws.name}</strong><br>
                            <small style="color: #666;">ID: ${ws.id}</small>
                         </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
    }

    function selectWorkspace(id, name) {
        document.getElementById('clickupWorkspaceId').value = id;
        document.getElementById('workspacesList').innerHTML =
            `<p style="color: green;">‚úÖ Selected: ${name}</p>`;
    }

    async function loadSpaces() {
        const workspaceId = document.getElementById('clickupWorkspaceId').value;
        if (!workspaceId) {
            alert('Please select a workspace first');
            return;
        }

        const container = document.getElementById('spacesList');
        container.innerHTML = '<p>Loading...</p>';

        try {
            const response = await fetch(`/employees/<%= employee.id %>/clickup/spaces/${workspaceId}`);
            if (!response.ok) throw new Error('Failed to load spaces');

            const spaces = await response.json();
            if (spaces.length === 0) {
                container.innerHTML = '<p style="color: #666;">No spaces found</p>';
                return;
            }

            let html = '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">';
            spaces.forEach(space => {
                html += `<div style="padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 4px; cursor: pointer;"
                              onclick="selectSpace('${space.id}', '${space.name}')">
                            <strong>${space.name}</strong><br>
                            <small style="color: #666;">ID: ${space.id}</small>
                         </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
    }

    function selectSpace(id, name) {
        document.getElementById('clickupSpaceId').value = id;
        document.getElementById('spacesList').innerHTML =
            `<p style="color: green;">‚úÖ Selected: ${name}</p>`;
    }

    async function loadLists() {
        const spaceId = document.getElementById('clickupSpaceId').value;
        if (!spaceId) {
            alert('Please select a space first');
            return;
        }

        const container = document.getElementById('listsList');
        container.innerHTML = '<p>Loading...</p>';

        try {
            const response = await fetch(`/employees/<%= employee.id %>/clickup/lists/${spaceId}`);
            if (!response.ok) throw new Error('Failed to load lists');

            const lists = await response.json();
            if (lists.length === 0) {
                container.innerHTML = '<p style="color: #666;">No lists found</p>';
                return;
            }

            let html = '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">';
            lists.forEach(list => {
                html += `<div style="padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 4px; cursor: pointer;"
                              onclick="selectList('${list.id}', '${list.name}')">
                            <strong>${list.name}</strong><br>
                            <small style="color: #666;">ID: ${list.id}</small>
                         </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
    }

    function selectList(id, name) {
        document.getElementById('clickupListId').value = id;
        document.getElementById('listsList').innerHTML =
            `<p style="color: green;">‚úÖ Selected: ${name}</p>`;
    }

    async function registerWebhook() {
        if (!confirm('Register webhook for this employee? They will receive Telegram notifications for all task events.')) {
            return;
        }

        try {
            const response = await fetch('/employees/<%= employee.id %>/clickup/register-webhook', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok && result.success) {
                alert('‚úÖ Webhook registered successfully! The page will reload.');
                window.location.reload();
            } else {
                alert('‚ùå Failed to register webhook: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }

    async function unregisterWebhook() {
        if (!confirm('Unregister webhook? Employee will stop receiving automatic task notifications.')) {
            return;
        }

        try {
            const response = await fetch('/employees/<%= employee.id %>/clickup/unregister-webhook', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok && result.success) {
                alert('‚úÖ Webhook unregistered successfully! The page will reload.');
                window.location.reload();
            } else {
                alert('‚ùå Failed to unregister webhook: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }
</script>
