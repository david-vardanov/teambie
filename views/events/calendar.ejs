<% layout('layouts/boilerplate') %>

<div class="calendar-header">
    <h1>Vacation Calendar <%= year %></h1>
    <div class="calendar-nav">
        <a href="/events/calendar?year=<%= year - 1 %>" class="btn btn-secondary">&larr; <%= year - 1 %></a>
        <a href="/events/calendar" class="btn btn-secondary">Today</a>
        <a href="/events/calendar?year=<%= year + 1 %>" class="btn btn-secondary"><%= year + 1 %> &rarr;</a>
        <% if (isAdmin) { %>
            <a href="/events/calendar/export?year=<%= year %>" class="btn btn-success" style="margin-left: 10px;">ðŸ“¥ Download Excel</a>
        <% } %>
    </div>
</div>

<div class="calendar-table-container">
    <div class="calendar-legend">
        <div class="legend-horizontal">
            <span class="legend-item"><span class="badge badge-vacation draggable-badge" draggable="true" data-event-type="VACATION">Vacation</span></span>
            <span class="legend-item"><span class="badge badge-holiday draggable-badge" draggable="true" data-event-type="HOLIDAY">Holiday</span></span>
            <span class="legend-item"><span class="badge badge-sick-day draggable-badge" draggable="true" data-event-type="SICK_DAY">Sick Day</span></span>
            <span class="legend-item"><span class="badge badge-home-office draggable-badge" draggable="true" data-event-type="HOME_OFFICE">Home Office</span></span>
            <span class="legend-item"><span class="badge badge-late-left-early draggable-badge" draggable="true" data-event-type="LATE_LEFT_EARLY">Late/Left Early</span></span>
            <span class="legend-item"><span class="badge badge-day-off-paid draggable-badge" draggable="true" data-event-type="DAY_OFF_PAID">Day Off Paid</span></span>
            <span class="legend-item"><span class="badge badge-day-off-unpaid draggable-badge" draggable="true" data-event-type="DAY_OFF_UNPAID">Day Off Unpaid</span></span>
        </div>
    </div>

    <div class="table-scroll-wrapper">
        <table class="calendar-table">
            <thead>
                <tr>
                    <th class="sticky-col first-col" rowspan="2">Employee</th>
                    <th class="sticky-col second-col" rowspan="2">Vacation</th>
                    <%
                        // Calculate total days in year for colspan
                        let totalDays = 0;
                        monthsData.forEach(md => {
                            totalDays += md.daysInMonth;
                        });
                    %>
                    <% monthsData.forEach((monthData, idx) => { %>
                        <th colspan="<%= monthData.daysInMonth %>" class="month-header" data-month="<%= idx %>" data-original-colspan="<%= monthData.daysInMonth %>"><%= monthNames[idx] %></th>
                    <% }) %>
                </tr>
                <tr>
                    <% monthsData.forEach((monthData, monthIndex) => { %>
                        <% for (let day = 1; day <= monthData.daysInMonth; day++) { %>
                            <%
                                const currentDate = new Date(year, monthIndex, day);
                                const dayOfWeek = currentDate.getDay();
                                const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                const isToday = today.getDate() === day && today.getMonth() === monthIndex && today.getFullYear() === year;
                            %>
                            <th class="day-header <%= isWeekend ? 'weekend' : '' %> <%= isToday ? 'today' : '' %>" data-date="<%= year %>-<%= (monthIndex + 1).toString().padStart(2, '0') %>-<%= day.toString().padStart(2, '0') %>" data-month="<%= monthIndex %>">
                                <div class="day-number"><%= day %></div>
                                <div class="day-name"><%= dayNames[dayOfWeek] %></div>
                            </th>
                        <% } %>
                    <% }) %>
                </tr>
            </thead>
            <tbody>
                <% if (employeeStats.length > 0) { %>
                    <% employeeStats.forEach(emp => { %>
                        <tr>
                            <td class="sticky-col first-col employee-name">
                                <a href="/employees/<%= emp.id %>"><%= emp.name %></a>
                            </td>
                            <td class="sticky-col second-col vacation-count">
                                <%= emp.vacationDays %>
                            </td>
                            <% monthsData.forEach((monthData, monthIndex) => { %>
                                <% for (let day = 1; day <= monthData.daysInMonth; day++) { %>
                                    <%
                                        const currentDate = new Date(year, monthIndex, day);
                                        const dayOfWeek = currentDate.getDay();
                                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                        const isToday = today.getDate() === day && today.getMonth() === monthIndex && today.getFullYear() === year;

                                        // Find events for this employee on this day
                                        const dayEvents = events.filter(e => {
                                            if (!e.employee || e.employee.id !== emp.id) return false;
                                            const eventStart = new Date(e.startDate);
                                            const eventEnd = e.endDate ? new Date(e.endDate) : eventStart;
                                            return currentDate >= new Date(eventStart.toDateString()) && currentDate <= new Date(eventEnd.toDateString());
                                        });

                                        // Create a cell class based on event types
                                        let cellClass = isWeekend ? 'weekend' : '';
                                        if (isToday) cellClass += ' today';

                                        if (dayEvents.length > 0) {
                                            cellClass += ' has-event';
                                        }

                                        // Create events data for JSON storage
                                        const eventsData = dayEvents.map(evt => ({
                                            id: evt.id,
                                            type: evt.type,
                                            employeeName: evt.employee ? evt.employee.name : 'Global Holiday',
                                            notes: evt.notes || '',
                                            startDate: evt.startDate.toLocaleDateString(),
                                            endDate: evt.endDate ? evt.endDate.toLocaleDateString() : evt.startDate.toLocaleDateString()
                                        }));
                                    %>
                                    <td class="day-cell <%= cellClass %>"
                                        data-employee-id="<%= emp.id %>"
                                        data-employee-name="<%= emp.name %>"
                                        data-date="<%= year %>-<%= (monthIndex + 1).toString().padStart(2, '0') %>-<%= day.toString().padStart(2, '0') %>"
                                        <% if (dayEvents.length > 0) { %>data-events='<%= JSON.stringify(eventsData) %>'<% } %>>
                                        <% if (dayEvents.length > 0) { %>
                                            <div class="event-indicators-wrapper">
                                                <% dayEvents.forEach((evt, idx) => {
                                                    const badgeClass = `badge-${evt.type.toLowerCase().replace(/_/g, '-')}`;
                                                %>
                                                    <span class="event-indicator <%= badgeClass %>" style="<%= dayEvents.length > 1 ? `width: ${100 / dayEvents.length}%` : '' %>"></span>
                                                <% }) %>
                                            </div>
                                        <% } %>
                                    </td>
                                <% } %>
                            <% }) %>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="<%= totalDays + 2 %>" class="empty-state">No employees found</td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>

    <!-- Employee Stats Section -->
    <div class="calendar-stats-section">
        <h3>Employee Statistics (<%= year %>)</h3>
        <% if (employeeStats.length > 0) { %>
            <div class="stats-table-wrapper">
                <table class="stats-summary-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Vacation</th>
                            <th>Holiday</th>
                            <th>Sick Days</th>
                            <th>Home Office</th>
                            <th>Paid Day Off</th>
                            <th>Unpaid Day Off</th>
                            <th>Late/Left Early</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% employeeStats.forEach(emp => { %>
                            <tr>
                                <td class="employee-name-col"><a href="/employees/<%= emp.id %>"><%= emp.name %></a></td>
                                <td><span class="stat-badge badge-vacation"><%= emp.vacationDays %>/<%= emp.vacationAllowance %></span></td>
                                <td><span class="stat-badge badge-holiday"><%= emp.holidayDays %>/<%= emp.holidayAllowance %></span></td>
                                <td><span class="stat-badge badge-sick-day"><%= emp.sickDays %></span></td>
                                <td><span class="stat-badge badge-home-office"><%= emp.homeOfficeDays %></span></td>
                                <td><span class="stat-badge badge-day-off-paid"><%= emp.paidDayOffDays || 0 %></span></td>
                                <td><span class="stat-badge badge-day-off-unpaid"><%= emp.unpaidDayOffDays || 0 %></span></td>
                                <td><span class="stat-badge badge-late-left-early"><%= emp.lateLeftEarlyDays || 0 %></span></td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <p class="empty-state">No employee statistics available</p>
        <% } %>
    </div>
</div>

<!-- Event Modal -->
<div class="event-modal-overlay" id="eventModal">
    <div class="event-modal">
        <div class="event-modal-header">
            <h3 id="modalTitle">Event Details</h3>
            <button class="event-modal-close" id="closeModal">&times;</button>
        </div>
        <div class="event-modal-body" id="modalEventsList">
            <!-- Events will be dynamically inserted here -->
        </div>
        <div class="event-modal-footer">
            <button class="btn btn-secondary" id="closeModalBtn">Close</button>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-header" id="contextMenuHeader">
        <!-- Event info will be inserted here -->
    </div>
    <ul class="context-menu-items">
        <li class="context-menu-item" id="contextMenuEdit">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
            </svg>
            <span>Edit Event</span>
        </li>
        <li class="context-menu-item context-menu-item-danger" id="contextMenuDelete">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
            <span>Delete Event</span>
        </li>
        <li class="context-menu-item" id="contextMenuViewAll">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
            </svg>
            <span>View All Events</span>
        </li>
    </ul>
</div>

<!-- Clear Filter Button -->
<button class="clear-filter-btn" id="clearFilterBtn">Clear Filter</button>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('eventModal');
    const closeModalBtn = document.getElementById('closeModal');
    const closeModalFooterBtn = document.getElementById('closeModalBtn');
    const tableWrapper = document.querySelector('.table-scroll-wrapper');

    // ============================================
    // ROW HIGHLIGHTING ON CELL HOVER
    // ============================================

    const dayCellsForHover = document.querySelectorAll('.calendar-table tbody td.day-cell');

    dayCellsForHover.forEach(cell => {
        cell.addEventListener('mouseenter', function() {
            // Get the parent row
            const row = this.closest('tr');
            if (row) {
                // Add highlight class to the row
                row.classList.add('row-highlighted');

                // Add highlight class to the employee name cell
                const employeeNameCell = row.querySelector('td.employee-name');
                if (employeeNameCell) {
                    employeeNameCell.classList.add('employee-highlighted');
                }
            }
        });

        cell.addEventListener('mouseleave', function() {
            // Get the parent row
            const row = this.closest('tr');
            if (row) {
                // Remove highlight class from the row
                row.classList.remove('row-highlighted');

                // Remove highlight class from the employee name cell
                const employeeNameCell = row.querySelector('td.employee-name');
                if (employeeNameCell) {
                    employeeNameCell.classList.remove('employee-highlighted');
                }
            }
        });
    });

    // ============================================
    // EMPLOYEE FILTER FUNCTIONALITY
    // ============================================

    let currentFilteredEmployeeId = null;
    let removedElements = { headers: [], cells: [], rows: [], monthHeaders: [] };
    const clearFilterBtn = document.getElementById('clearFilterBtn');
    const employeeNameCells = document.querySelectorAll('.calendar-table tbody td.employee-name a');

    employeeNameCells.forEach(link => {
        // Prevent default navigation and add click handler for filtering
        link.addEventListener('click', function(e) {
            e.preventDefault();

            const employeeNameCell = this.closest('td.employee-name');
            const employeeRow = this.closest('tr');
            const employeeId = employeeRow.querySelector('.day-cell')?.dataset.employeeId;

            if (!employeeId) return;

            // If clicking the same employee, clear filter
            if (currentFilteredEmployeeId === employeeId) {
                clearEmployeeFilter();
                return;
            }

            // Set current filtered employee
            currentFilteredEmployeeId = employeeId;
            removedElements = { headers: [], cells: [], rows: [], monthHeaders: [] };

            // Find all days that have events for this employee
            const employeeCells = employeeRow.querySelectorAll('.day-cell');
            const daysWithEvents = new Set();

            employeeCells.forEach((cell) => {
                if (cell.classList.contains('has-event')) {
                    const date = cell.dataset.date;
                    if (date) {
                        daysWithEvents.add(date);
                    }
                }
            });

            // Remove day headers that don't have events for this employee
            const dayHeaders = document.querySelectorAll('.calendar-table thead th.day-header');
            dayHeaders.forEach((header) => {
                const headerDate = header.dataset.date;
                if (headerDate && !daysWithEvents.has(headerDate)) {
                    // Store the header and its position for restoration
                    removedElements.headers.push({
                        element: header,
                        parent: header.parentNode,
                        nextSibling: header.nextSibling
                    });
                    // Remove from DOM
                    header.remove();
                }
            });

            // Remove corresponding cells from ALL rows
            const allBodyRows = document.querySelectorAll('.calendar-table tbody tr');
            allBodyRows.forEach(row => {
                const cellsInRow = row.querySelectorAll('.day-cell');
                cellsInRow.forEach(cell => {
                    const cellDate = cell.dataset.date;
                    if (cellDate && !daysWithEvents.has(cellDate)) {
                        // Store the cell and its position for restoration
                        removedElements.cells.push({
                            element: cell,
                            parent: cell.parentNode,
                            nextSibling: cell.nextSibling
                        });
                        // Remove from DOM
                        cell.remove();
                    }
                });
            });

            // Hide all rows except the selected employee
            allBodyRows.forEach(row => {
                const firstCell = row.querySelector('.day-cell');
                if (firstCell && firstCell.dataset.employeeId !== employeeId) {
                    removedElements.rows.push({
                        element: row,
                        parent: row.parentNode,
                        nextSibling: row.nextSibling
                    });
                    row.remove();
                }
            });

            // Update month header colspans based on remaining visible days
            const monthHeaders = document.querySelectorAll('.calendar-table thead th.month-header');
            const visibleDayHeaders = document.querySelectorAll('.calendar-table thead th.day-header');

            // Count visible days per month
            const monthDayCounts = {};
            visibleDayHeaders.forEach(header => {
                const month = header.dataset.month;
                if (month) {
                    monthDayCounts[month] = (monthDayCounts[month] || 0) + 1;
                }
            });

            // Update colspan for each month header and hide if no days
            monthHeaders.forEach(monthHeader => {
                const month = monthHeader.dataset.month;
                const originalColspan = monthHeader.dataset.originalColspan;
                const newColspan = monthDayCounts[month] || 0;

                if (newColspan === 0) {
                    // Store and remove month header if no days visible
                    removedElements.monthHeaders.push({
                        element: monthHeader,
                        parent: monthHeader.parentNode,
                        nextSibling: monthHeader.nextSibling,
                        originalColspan: originalColspan
                    });
                    monthHeader.remove();
                } else if (newColspan !== parseInt(originalColspan)) {
                    // Update colspan
                    monthHeader.setAttribute('colspan', newColspan);
                }
            });

            // Add visual indicator to the active employee
            employeeNameCell.classList.add('filter-active');

            // Add filtered-view class to table wrapper for expanded cells
            if (tableWrapper) {
                tableWrapper.classList.add('filtered-view');
            }

            // Show clear filter button
            clearFilterBtn.classList.add('active');

            // Show notification
            const employeeName = this.textContent;
            showNotification(`Showing only days with events for ${employeeName}`, 'info');
        });
    });

    // Clear filter button handler
    clearFilterBtn.addEventListener('click', clearEmployeeFilter);

    function clearEmployeeFilter() {
        // Clear filtered employee
        currentFilteredEmployeeId = null;

        // Restore all removed rows
        removedElements.rows.forEach(item => {
            if (item.nextSibling) {
                item.parent.insertBefore(item.element, item.nextSibling);
            } else {
                item.parent.appendChild(item.element);
            }
        });

        // Restore all removed cells
        removedElements.cells.forEach(item => {
            if (item.nextSibling) {
                item.parent.insertBefore(item.element, item.nextSibling);
            } else {
                item.parent.appendChild(item.element);
            }
        });

        // Restore all removed headers
        removedElements.headers.forEach(item => {
            if (item.nextSibling) {
                item.parent.insertBefore(item.element, item.nextSibling);
            } else {
                item.parent.appendChild(item.element);
            }
        });

        // Restore all removed month headers
        removedElements.monthHeaders.forEach(item => {
            if (item.nextSibling) {
                item.parent.insertBefore(item.element, item.nextSibling);
            } else {
                item.parent.appendChild(item.element);
            }
        });

        // Restore original colspan values for all month headers
        const monthHeaders = document.querySelectorAll('.calendar-table thead th.month-header');
        monthHeaders.forEach(monthHeader => {
            const originalColspan = monthHeader.dataset.originalColspan;
            if (originalColspan) {
                monthHeader.setAttribute('colspan', originalColspan);
            }
        });

        // Clear the removed elements storage
        removedElements = { headers: [], cells: [], rows: [], monthHeaders: [] };

        // Remove filter active indicator
        const activeEmployeeName = document.querySelector('.employee-name.filter-active');
        if (activeEmployeeName) {
            activeEmployeeName.classList.remove('filter-active');
        }

        // Remove filtered-view class from table wrapper
        if (tableWrapper) {
            tableWrapper.classList.remove('filtered-view');
        }

        // Hide clear filter button
        clearFilterBtn.classList.remove('active');

        showNotification('Filter cleared - showing all employees', 'success');
    }

    // Auto-scroll to today's column immediately
    const todayCell = document.querySelector('.calendar-table .day-header.today');
    if (todayCell && tableWrapper) {
        const stickyColsWidth = 300; // width of sticky columns (employee + vacation)
        const scrollLeft = todayCell.offsetLeft - (tableWrapper.clientWidth / 2) - stickyColsWidth + (todayCell.offsetWidth / 2);
        tableWrapper.scrollLeft = Math.max(0, scrollLeft);
    }

    // Event delegation for event indicators (left click)
    document.addEventListener('click', function(e) {
        const cell = e.target.closest('.day-cell.has-event');
        if (cell && !e.defaultPrevented) {
            e.preventDefault();

            // Get events data from cell
            const eventsData = cell.dataset.events;
            if (!eventsData) return;

            const events = JSON.parse(eventsData);
            const modalEventsList = document.getElementById('modalEventsList');

            // Update modal title
            document.getElementById('modalTitle').textContent = events.length > 1
                ? `Events (${events.length})`
                : 'Event Details';

            // Clear previous content
            modalEventsList.innerHTML = '';

            // Add each event
            events.forEach((event, index) => {
                const formattedType = event.type.replace(/_/g, ' ');
                const badgeClass = 'badge-' + event.type.toLowerCase().replace(/_/g, '-');

                const eventCard = document.createElement('div');
                eventCard.className = 'event-card';
                if (index > 0) eventCard.style.marginTop = '1rem';
                if (index > 0) eventCard.style.paddingTop = '1rem';
                if (index > 0) eventCard.style.borderTop = '1px solid #e0e0e0';

                eventCard.innerHTML = `
                    <div class="event-modal-field">
                        <span class="event-modal-label">Type</span>
                        <div class="event-modal-value">
                            <span class="badge ${badgeClass}">${formattedType}</span>
                        </div>
                    </div>
                    <div class="event-modal-field">
                        <span class="event-modal-label">Employee</span>
                        <div class="event-modal-value">${event.employeeName || 'N/A'}</div>
                    </div>
                    <div class="event-modal-field">
                        <span class="event-modal-label">Start Date</span>
                        <div class="event-modal-value">${event.startDate || 'N/A'}</div>
                    </div>
                    <div class="event-modal-field">
                        <span class="event-modal-label">End Date</span>
                        <div class="event-modal-value">${event.endDate || 'N/A'}</div>
                    </div>
                    ${event.notes && event.notes.trim() !== '' ? `
                        <div class="event-modal-field">
                            <span class="event-modal-label">Notes</span>
                            <div class="event-modal-value">${event.notes}</div>
                        </div>
                    ` : ''}
                    <div class="event-modal-field">
                        <a href="/events/${event.id}" class="btn btn-sm btn-primary">View Full Details</a>
                    </div>
                `;

                modalEventsList.appendChild(eventCard);
            });

            // Show modal
            modal.classList.add('active');
        }
    });

    // Close modal handlers
    function closeModal() {
        modal.classList.remove('active');
    }

    closeModalBtn.addEventListener('click', closeModal);
    closeModalFooterBtn.addEventListener('click', closeModal);

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    // ============================================
    // CONTEXT MENU FUNCTIONALITY
    // ============================================

    const contextMenu = document.getElementById('contextMenu');
    const contextMenuHeader = document.getElementById('contextMenuHeader');
    const contextMenuEdit = document.getElementById('contextMenuEdit');
    const contextMenuDelete = document.getElementById('contextMenuDelete');
    const contextMenuViewAll = document.getElementById('contextMenuViewAll');
    let currentContextEvent = null;
    let currentContextCell = null;

    // Handle right-click on calendar cells
    document.addEventListener('contextmenu', function(e) {
        const cell = e.target.closest('.day-cell.has-event');

        if (cell) {
            e.preventDefault();

            // Get events data from cell
            const eventsData = cell.dataset.events;
            if (!eventsData) return;

            const events = JSON.parse(eventsData);

            // If multiple events, show the first one in context menu (or enhance to show selector)
            currentContextEvent = events[0];
            currentContextCell = cell;

            // Update context menu header
            const formattedType = currentContextEvent.type.replace(/_/g, ' ');
            const badgeClass = 'badge-' + currentContextEvent.type.toLowerCase().replace(/_/g, '-');

            contextMenuHeader.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <span class="badge ${badgeClass}" style="align-self: flex-start;">${formattedType}</span>
                    <div style="font-size: 0.875rem; color: #666;">
                        <strong>${currentContextEvent.employeeName}</strong>
                    </div>
                    <div style="font-size: 0.75rem; color: #999;">
                        ${currentContextEvent.startDate}
                    </div>
                </div>
            `;

            // If multiple events, show indicator
            if (events.length > 1) {
                contextMenuHeader.innerHTML += `
                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e0e0e0; font-size: 0.75rem; color: #999;">
                        +${events.length - 1} more event${events.length > 2 ? 's' : ''}
                    </div>
                `;
            }

            // Position context menu at cursor
            const menuWidth = 250;
            const menuHeight = 200; // approximate
            let x = e.pageX;
            let y = e.pageY;

            // Adjust if menu would go off-screen
            if (x + menuWidth > window.innerWidth + window.scrollX) {
                x = window.innerWidth + window.scrollX - menuWidth - 10;
            }
            if (y + menuHeight > window.innerHeight + window.scrollY) {
                y = window.innerHeight + window.scrollY - menuHeight - 10;
            }

            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.classList.add('active');

            // Prevent the regular click handler from firing
            e.stopPropagation();
        }
    });

    // Close context menu on click outside
    document.addEventListener('click', function(e) {
        if (!contextMenu.contains(e.target)) {
            contextMenu.classList.remove('active');
        }
    });

    // Close context menu on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && contextMenu.classList.contains('active')) {
            contextMenu.classList.remove('active');
        }
    });

    // Edit event handler
    contextMenuEdit.addEventListener('click', function() {
        if (currentContextEvent) {
            window.location.href = `/events/${currentContextEvent.id}/edit`;
        }
        contextMenu.classList.remove('active');
    });

    // Delete event handler
    contextMenuDelete.addEventListener('click', function() {
        if (!currentContextEvent) return;

        if (confirm(`Are you sure you want to delete this ${currentContextEvent.type.replace(/_/g, ' ')} event?`)) {
            deleteEvent(currentContextEvent.id, currentContextCell);
        }
        contextMenu.classList.remove('active');
    });

    // View all events handler
    contextMenuViewAll.addEventListener('click', function() {
        if (currentContextCell) {
            // Trigger the existing modal by simulating a click
            currentContextCell.click();
        }
        contextMenu.classList.remove('active');
    });

    // Function to delete event via AJAX
    function deleteEvent(eventId, cell) {
        fetch(`/events/${eventId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete event');
            }
            return response.json();
        })
        .then(data => {
            // Success - remove visual indicator from the cell
            const eventsData = cell.dataset.events ? JSON.parse(cell.dataset.events) : [];
            const updatedEvents = eventsData.filter(e => e.id !== eventId);

            if (updatedEvents.length === 0) {
                // Remove all indicators
                cell.classList.remove('has-event');
                const wrapper = cell.querySelector('.event-indicators-wrapper');
                if (wrapper) wrapper.remove();
                delete cell.dataset.events;
            } else {
                // Update the data and recalculate indicator widths
                cell.dataset.events = JSON.stringify(updatedEvents);

                const wrapper = cell.querySelector('.event-indicators-wrapper');
                if (wrapper) {
                    // Rebuild indicators
                    wrapper.innerHTML = '';
                    updatedEvents.forEach(evt => {
                        const badgeClass = 'badge-' + evt.type.toLowerCase().replace(/_/g, '-');
                        const indicator = document.createElement('span');
                        indicator.className = `event-indicator ${badgeClass}`;
                        if (updatedEvents.length > 1) {
                            indicator.style.width = `${100 / updatedEvents.length}%`;
                        }
                        wrapper.appendChild(indicator);
                    });
                }
            }

            // Show success animation
            cell.classList.add('drop-success');
            setTimeout(() => {
                cell.classList.remove('drop-success');
            }, 600);

            showNotification('Event deleted successfully', 'success');
        })
        .catch(error => {
            console.error('Error deleting event:', error);
            showNotification('Failed to delete event. Please try again.', 'error');
        });
    }

    // ============================================
    // DRAG AND DROP FUNCTIONALITY
    // ============================================

    let draggedEventType = null;
    let draggedBadgeClass = null;

    // Handle drag start on legend badges
    const draggableBadges = document.querySelectorAll('.draggable-badge');
    draggableBadges.forEach(badge => {
        badge.addEventListener('dragstart', function(e) {
            draggedEventType = this.dataset.eventType;
            // Get the badge class (e.g., 'badge-vacation')
            const badgeClasses = Array.from(this.classList).find(cls => cls.startsWith('badge-') && cls !== 'badge');
            draggedBadgeClass = badgeClasses;

            // Set data for transfer
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', draggedEventType);

            // Add dragging class for visual feedback
            this.classList.add('dragging');

            // Create custom drag image (optional - badge will be default)
            const dragImg = this.cloneNode(true);
            dragImg.style.opacity = '0.8';
            dragImg.style.transform = 'scale(1.1)';
            document.body.appendChild(dragImg);
            e.dataTransfer.setDragImage(dragImg, 40, 15);
            setTimeout(() => document.body.removeChild(dragImg), 0);
        });

        badge.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
            // Remove all drop-target classes from cells
            document.querySelectorAll('.day-cell').forEach(cell => {
                cell.classList.remove('drop-target', 'drop-target-hover');
            });
            // Remove all row highlighting
            document.querySelectorAll('.calendar-table tbody tr').forEach(row => {
                row.classList.remove('row-highlighted');
            });
            document.querySelectorAll('.calendar-table tbody td.employee-name').forEach(empCell => {
                empCell.classList.remove('employee-highlighted');
            });
        });

        // Add cursor style on hover
        badge.style.cursor = 'grab';
        badge.addEventListener('mousedown', function() {
            this.style.cursor = 'grabbing';
        });
        badge.addEventListener('mouseup', function() {
            this.style.cursor = 'grab';
        });
    });

    // Handle drag over calendar cells
    const dayCells = document.querySelectorAll('.day-cell');
    dayCells.forEach(cell => {
        cell.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';

            // Add hover effect
            if (!this.classList.contains('drop-target-hover')) {
                this.classList.add('drop-target', 'drop-target-hover');
            }

            // Add row highlighting during drag
            const row = this.closest('tr');
            if (row) {
                row.classList.add('row-highlighted');
                const employeeNameCell = row.querySelector('td.employee-name');
                if (employeeNameCell) {
                    employeeNameCell.classList.add('employee-highlighted');
                }
            }
        });

        cell.addEventListener('dragenter', function(e) {
            e.preventDefault();
            this.classList.add('drop-target');

            // Add row highlighting during drag
            const row = this.closest('tr');
            if (row) {
                row.classList.add('row-highlighted');
                const employeeNameCell = row.querySelector('td.employee-name');
                if (employeeNameCell) {
                    employeeNameCell.classList.add('employee-highlighted');
                }
            }
        });

        cell.addEventListener('dragleave', function(e) {
            // Only remove if we're actually leaving the cell (not entering a child)
            if (e.target === this) {
                this.classList.remove('drop-target', 'drop-target-hover');

                // Remove row highlighting when leaving during drag
                const row = this.closest('tr');
                if (row) {
                    row.classList.remove('row-highlighted');
                    const employeeNameCell = row.querySelector('td.employee-name');
                    if (employeeNameCell) {
                        employeeNameCell.classList.remove('employee-highlighted');
                    }
                }
            }
        });

        cell.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drop-target', 'drop-target-hover');

            // Remove row highlighting after drop
            const row = this.closest('tr');
            if (row) {
                row.classList.remove('row-highlighted');
                const employeeNameCell = row.querySelector('td.employee-name');
                if (employeeNameCell) {
                    employeeNameCell.classList.remove('employee-highlighted');
                }
            }

            const employeeId = this.dataset.employeeId;
            const employeeName = this.dataset.employeeName;
            const date = this.dataset.date;

            if (!employeeId || !date || !draggedEventType) {
                return;
            }

            // Add visual feedback immediately
            this.classList.add('drop-success');

            // Create the event via AJAX
            createEvent(employeeId, employeeName, date, draggedEventType, draggedBadgeClass, this);
        });
    });

    // Function to create event via AJAX
    function createEvent(employeeId, employeeName, date, eventType, badgeClass, cell) {
        fetch('/events', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                employeeId: employeeId,
                type: eventType,
                startDate: date,
                endDate: date,
                notes: 'Created via drag & drop'
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to create event');
            }
            return response.json();
        })
        .then(data => {
            // Success - add visual indicator to the cell
            const existingWrapper = cell.querySelector('.event-indicators-wrapper');

            if (existingWrapper) {
                // Add to existing indicators
                const indicator = document.createElement('span');
                indicator.className = `event-indicator ${badgeClass}`;

                // Recalculate widths
                const allIndicators = existingWrapper.querySelectorAll('.event-indicator');
                const newCount = allIndicators.length + 1;
                allIndicators.forEach(ind => {
                    ind.style.width = `${100 / newCount}%`;
                });
                indicator.style.width = `${100 / newCount}%`;

                existingWrapper.appendChild(indicator);
            } else {
                // Create new wrapper and indicator
                const wrapper = document.createElement('div');
                wrapper.className = 'event-indicators-wrapper';

                const indicator = document.createElement('span');
                indicator.className = `event-indicator ${badgeClass}`;

                wrapper.appendChild(indicator);
                cell.appendChild(wrapper);
                cell.classList.add('has-event');
            }

            // Update data-events attribute
            const currentEvents = cell.dataset.events ? JSON.parse(cell.dataset.events) : [];
            currentEvents.push({
                id: data.id,
                type: eventType,
                employeeName: employeeName,
                notes: 'Created via drag & drop',
                startDate: new Date(date).toLocaleDateString(),
                endDate: new Date(date).toLocaleDateString()
            });
            cell.dataset.events = JSON.stringify(currentEvents);

            // Remove success animation after delay
            setTimeout(() => {
                cell.classList.remove('drop-success');
            }, 600);

            // Show success message
            showNotification(`${eventType.replace(/_/g, ' ')} added for ${employeeName} on ${new Date(date).toLocaleDateString()}`, 'success');
        })
        .catch(error => {
            console.error('Error creating event:', error);
            cell.classList.remove('drop-success');
            cell.classList.add('drop-error');
            setTimeout(() => {
                cell.classList.remove('drop-error');
            }, 600);
            showNotification('Failed to create event. Please try again.', 'error');
        });
    }

    // Simple notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
});
</script>
